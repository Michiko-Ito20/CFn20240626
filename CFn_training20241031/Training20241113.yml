################
# 添付の設計書（Markdown）を満たすCFnテンプレートを作成しなさい。
# mainブランチから新規ブランチを作成して開発を行うこと.
# 添付資料の公開、GitHubへの投入は禁止する
# 作成するテンプレートは1ファイルで構わない（分割しなくてよい）
# 構築されたリソースすべてが要件を満たしていることが終了条件
# 中間提出も可とするが、提出方式はPRとし、レビューが終わったら都度マージすること。レビュー依頼時にはレビュアーがレビューすべき点をPR依頼文に記載すること。
#/```
#{
#    "Version": "2012-10-17",
#    "Statement": [
#        {
#            "Sid": "AWSTrailLogsBucketPermissionsCheck",
#            "Effect": "Allow",
#            "Principal": {
#                "Service": "cloudtrail.amazonaws.com"
#            },
#            "Action": "s3:GetBucketAcl",
#            "Resource": "arn:aws:s3:::aws-cloudtrail-logs-${AWS::AccountId}"
#        },
#        {
#            "Sid": "AWSTrailLogsBucketDelivery",
#            "Effect": "Allow",
#            "Principal": {
#                "Service": "cloudtrail.amazonaws.com"
#            },
#            "Action": "s3:PutObject",
#            "Resource": "arn:aws:s3:::aws-cloudtrail-logs-${AWS::AccountId}/AWSLogs/${AWS::AccountId}/*",
#            "Condition": {
#                "StringEquals": {
#                    "s3:x-amz-acl": "bucket-owner-full-control"
#                }
#            }
#        }
#    ]
#}
#/```
# /```
# {
#    "Version": "2012-10-17",
#    "Statement": [
#        {
#            "Sid": "AWSConfigBucketPermissionsCheck",
#            "Effect": "Allow",
#            "Principal": {
#                "Service": "config.amazonaws.com"
#            },
#            "Action": "s3:GetBucketAcl",
#            "Resource": "arn:aws:s3:::aws-config-logs-${AWS::AccountId}",
#            "Condition": {
#                "StringEquals": {
#                    "AWS:SourceAccount": "${AWS::AccountId}"
#                }
#            }
#        },
#        {
#            "Sid": "AWSConfigBucketExistenceCheck",
#            "Effect": "Allow",
#            "Principal": {
#                "Service": "config.amazonaws.com"
#            },
#            "Action": "s3:ListBucket",
#            "Resource": "arn:aws:s3:::aws-config-logs-${AWS::AccountId}",
#            "Condition": {
#                "StringEquals": {
#                    "AWS:SourceAccount": "${AWS::AccountId}"
#                }
#            }
#        },
#        {
#            "Sid": "AWSConfigBucketDelivery",
#            "Effect": "Allow",
#            "Principal": {
#                "Service": "config.amazonaws.com"
#            },
#            "Action": "s3:PutObject",
#            "Resource": "arn:aws:s3:::aws-config-logs-${AWS::AccountId}/AWSLogs/${AWS::AccountId}/Config/*",
#            "Condition": {
#                "StringEquals": {
#                    "AWS:SourceAccount": "${AWS::AccountId}",
#                    "s3:x-amz-acl": "bucket-owner-full-control"
#                }
#            }
#        }
#    ]
#}
#/```

# /```
# {
#    "Version": "2012-10-17",
#    "Statement": [
#        {
#            "Sid": "AWSConfigBucketPermissionsCheck",
#            "Effect": "Allow",
#            "Principal": {
#                "Service": "config.amazonaws.com"
#            },
#            "Action": "s3:GetBucketAcl",
#            "Resource": "arn:aws:s3:::aws-config-logs-${AWS::AccountId}",
#            "Condition": {
#                "StringEquals": {
#                    "AWS:SourceAccount": "${AWS::AccountId}"
#                }
#            }
#        },
#        {
#            "Sid": "AWSConfigBucketExistenceCheck",
#            "Effect": "Allow",
#            "Principal": {
#                "Service": "config.amazonaws.com"
#            },
#            "Action": "s3:ListBucket",
#            "Resource": "arn:aws:s3:::aws-config-logs-${AWS::AccountId}",
#            "Condition": {
#                "StringEquals": {
#                    "AWS:SourceAccount": "${AWS::AccountId}"
#                }
#            }
#        },
#        {
#            "Sid": "AWSConfigBucketDelivery",
#            "Effect": "Allow",
#            "Principal": {
#                "Service": "config.amazonaws.com"
#            },
#            "Action": "s3:PutObject",
#            "Resource": "arn:aws:s3:::aws-config-logs-${AWS::AccountId}/AWSLogs/${AWS::AccountId}/Config/*",
#            "Condition": {
#                "StringEquals": {
#                    "AWS:SourceAccount": "${AWS::AccountId}",
#                    "s3:x-amz-acl": "bucket-owner-full-control"
#                }
#            }
#        }
#    ]
#}
#/```
################

# Parameters:参照するものが無いのでいらない

AWSTemplateFormatVersion: 2010-09-09

Description: "AWS CloudTrail and AWS Config Setup" 

Resources:
  CloudTrailBucket:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !Sub 'aws-cloudtrail-logs-${AWS::AccountId}'
      LoggingConfiguration: 
        DestinationBucketName: !Ref 'AWS::NoValue'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: 'AES256'  
      VersioningConfiguration:
        Status: 'Suspended'  
      LifecycleConfiguration:
        Rules:
          - Id: 'trailsLifeCycle'
            Status: 'Enabled'
            Prefix: ''  
            ExpirationInDays: 366 
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true  
        IgnorePublicAcls: true  
        BlockPublicPolicy: true  
        RestrictPublicBuckets: true 
      AccessControl: 'BucketOwnerFullControl'

  CloudTrailBucketPolicy:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket: !Ref 'CloudTrailBucket'
      PolicyDocument: !Sub |
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "AWSTrailLogsBucketPermissionsCheck", 
              "Effect": "Allow",
              "Principal": {
                  "Service": "cloudtrail.amazonaws.com"
              },
              "Action": "s3:GetBucketAcl",
              "Resource": "arn:aws:s3:::aws-cloudtrail-logs-${AWS::AccountId}"
          },
          {
              "Sid": "AWSTrailLogsBucketDelivery",
              "Effect": "Allow",
              "Principal": {
                  "Service": "cloudtrail.amazonaws.com"
              },
              "Action": "s3:PutObject",
              "Resource": "arn:aws:s3:::aws-cloudtrail-logs-${AWS::AccountId}/AWSLogs/${AWS::AccountId}/*",
              "Condition": {
                  "StringEquals": {
                      "s3:x-amz-acl": "bucket-owner-full-control"
                  }
              }
            }
          ]
        }

  CloudTrail:
    Type: 'AWS::CloudTrail::Trail'
    Properties:
      TrailName: 'trails'
      S3BucketName: !Ref 'CloudTrailBucket'
      IncludeGlobalServiceEvents: true
      IsLogging: true
      EnableLogFileValidation: true
      IsMultiRegionTrail: false
      EventSelectors:
        - ReadWriteType: 'All'
          IncludeManagementEvents: true


  ConfigBucket:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !Sub 'aws-config-logs-${AWS::AccountId}'
      LifecycleConfiguration:
        Rules:
          - Id: 'configLogsLifeCycle'
            Status: 'Enabled'
            ExpirationInDays: 2557

  ConfigBucketPolicy:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket: !Ref 'ConfigBucket'
      PolicyDocument: !Sub |
        {
          "Version": "2012-10-17",
          "Statement": [
                {
                    "Sid": "AWSConfigBucketPermissionsCheck",
                    "Effect": "Allow",
                    "Principal": {
                        "Service": "config.amazonaws.com"
                    },
                    "Action": "s3:GetBucketAcl",
                    "Resource": "arn:aws:s3:::aws-config-logs-${AWS::AccountId}",
                    "Condition": {
                        "StringEquals": {
                            "AWS:SourceAccount": "${AWS::AccountId}"
                        }
                    }
                },
                {
                    "Sid": "AWSConfigBucketExistenceCheck",
                    "Effect": "Allow",
                    "Principal": {
                        "Service": "config.amazonaws.com"
                    },
                    "Action": "s3:ListBucket",
                    "Resource": "arn:aws:s3:::aws-config-logs-${AWS::AccountId}",
                    "Condition": {
                        "StringEquals": {
                            "AWS:SourceAccount": "${AWS::AccountId}"
                        }
                    }
                },
                {
                    "Sid": "AWSConfigBucketDelivery",
                    "Effect": "Allow",
                    "Principal": {
                        "Service": "config.amazonaws.com"
                    },
                    "Action": "s3:PutObject",
                    "Resource": "arn:aws:s3:::aws-config-logs-${AWS::AccountId}/AWSLogs/${AWS::AccountId}/Config/*",
                    "Condition": {
                        "StringEquals": {
                            "AWS:SourceAccount": "${AWS::AccountId}",
                            "s3:x-amz-acl": "bucket-owner-full-control"
                        }
                    }
                }
            ]
        }

  ConfigRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: 'config-role-ap-northeast-1'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Service: 'config.amazonaws.com'
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSConfigRole'

  ConfigRecorder:
    Type: 'AWS::Config::ConfigurationRecorder'
    Properties:
      Name: 'default'
      RoleARN: !GetAtt ConfigRole.Arn
      RecordingGroup:
        AllSupported: true

  ConfigDeliveryChannel:
    Type: 'AWS::Config::DeliveryChannel'
    Properties:
      S3BucketName: !Ref 'ConfigBucket'
      ConfigSnapshotDeliveryProperties:
        DeliveryFrequency: 'One_Hour'



LogicalID:
  Type: AWS::CloudTrail::Trail
  Properties:
    AdvancedEventSelectors: 
      - FieldSelectors:
          - EndsWith:
              - "String"
            Equals:
              - "String"
            Field: "String"
            NotEndsWith:
              - "String"
            NotEquals:
              - "String"
            NotStartsWith:
              - "String"
            StartsWith:
              - "String"
        Name: "String"
    CloudWatchLogsLogGroupArn: "String"
    CloudWatchLogsRoleArn: "String"
    EnableLogFileValidation: false
    EventSelectors: 
      - DataResources:
          - Type: "String"
            Values:
              - "String"
        ExcludeManagementEventSources:
          - "String"
        IncludeManagementEvents: false
        ReadWriteType: "String"
    IncludeGlobalServiceEvents: false
    InsightSelectors: 
      - InsightType: "String"
    IsLogging: false # Required
    IsMultiRegionTrail: false
    IsOrganizationTrail: false
    KMSKeyId: "String"
    S3BucketName: "String" # Required
    S3KeyPrefix: "String"
    SnsTopicName: "String"
    Tags: 
      - Key: "String"
        Value: "String"
    TrailName: "String"
